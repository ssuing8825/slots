parameters:
  subscription: "NOT_DEFINE"
  environment: "NOT_DEFINE"
  webAppName: "NOT_DEFINE"
  funcAppName: "NOT_DEFINE"
  subId : "NOT_DEFINE"

resources:
  repositories:
  - repository: slotsGitHub # The name used to reference this repository in the checkout step
    type: github
    endpoint: ssuing8825
    name: ssuing8825/slots

steps:
  - checkout: slotsGitHub

  - task: AzureCLI@2
    displayName: "Setup Auth for Terraform"
    inputs:
      azureSubscription: "${{ parameters.subscription }}"
      addSpnToEnvironment: true
      scriptLocation: inlineScript
      scriptType: pscore
      failOnStandardError: "true"
      inlineScript: |
        az account set --subscription ${{ parameters.subId }}
        Write-Host "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID]$(az account show --query="id" -o tsv)"
        Write-Host "##vso[task.setvariable variable=ARM_CLIENT_ID]$($env:servicePrincipalId)"
        Write-Host "##vso[task.setvariable variable=ARM_CLIENT_SECRET]$($env:servicePrincipalKey)"
        Write-Host "##vso[task.setvariable variable=ARM_TENANT_ID]$(az account show --query="tenantId" -o tsv)"

  - task: PowerShell@2
    displayName: Subscription to be Deployed To
    inputs:
      targetType: "inline"
      script: 'Write-Host "This is the Subscription to be deployed to: " ${{ parameters.subId }}'

  - task: AzureCLI@2
    displayName: "Deploy Infrastructure with Terraform"
    inputs:
      azureSubscription: "${{ parameters.subscription }}"
      scriptType: pscore
      scriptPath: $(Build.SourcesDirectory)/Terraform/init/deploy.ps1
      arguments: "-Environment ${{ parameters.environment }} -Verbose"
    env:
      TF_VAR_subscription_id: $(ARM_SUBSCRIPTION_ID)
      TF_VAR_client_id: $(ARM_CLIENT_ID)
      TF_VAR_client_secret: $(ARM_CLIENT_SECRET)
      TF_VAR_tenant_id: $(ARM_TENANT_ID)